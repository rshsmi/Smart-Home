- id: simple_calendar_fetch
  alias: Simple Calendar Fetch (3 events)
  description: Clears first 3 slots, fetches calendar events, stores earliest 3 upcoming.
  trigger:
    - platform: state
      entity_id: input_text.calendar_trigger
  condition: []
  action:
    # Clear existing stored events
    - service: input_text.set_value
      target:
        entity_id: input_text.event_1
      data:
        value: ''
    - service: input_text.set_value
      target:
        entity_id: input_text.event_2
      data:
        value: ''
    - service: input_text.set_value
      target:
        entity_id: input_text.event_3
      data:
        value: ''

    # Fetch events for the next 7 days
    - service: calendar.get_events
      target:
        entity_id: calendar.ravan_studio
      data:
        start_date_time: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        end_date_time: "{{ (now() + timedelta(days=7)).strftime('%Y-%m-%d 23:59:59') }}"
      response_variable: cal_events

    # Store first 3 events if present
    - if:
        - condition: template
          value_template: "{{ cal_events['calendar.ravan_studio']['events'] | length >= 1 }}"
      then:
        - service: input_text.set_value
          target:
            entity_id: input_text.event_1
          data:
            value: "{{ cal_events['calendar.ravan_studio']['events'][0].start }}|{{ cal_events['calendar.ravan_studio']['events'][0].summary }}"

    - if:
        - condition: template
          value_template: "{{ cal_events['calendar.ravan_studio']['events'] | length >= 2 }}"
      then:
        - service: input_text.set_value
          target:
            entity_id: input_text.event_2
          data:
            value: "{{ cal_events['calendar.ravan_studio']['events'][1].start }}|{{ cal_events['calendar.ravan_studio']['events'][1].summary }}"

    - if:
        - condition: template
          value_template: "{{ cal_events['calendar.ravan_studio']['events'] | length >= 3 }}"
      then:
        - service: input_text.set_value
          target:
            entity_id: input_text.event_3
          data:
            value: "{{ cal_events['calendar.ravan_studio']['events'][2].start }}|{{ cal_events['calendar.ravan_studio']['events'][2].summary }}"
  mode: single

- id: ev_track_session_energy
  alias: EV Track Session Energy
  description: Tracks the current session energy value
  trigger:
    - platform: state
      entity_id: sensor.anderson_ev_charger_connection_session_energy
  condition:
    - condition: template
      value_template: "{{ states('sensor.anderson_ev_charger_connection_session_energy') | float(0) > 0 }}"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.ev_last_session_energy
      data:
        value: "{{ states('sensor.anderson_ev_charger_connection_session_energy') | float(0) }}"
  mode: single

- id: ev_accumulate_session_energy
  alias: EV Accumulate Session Energy
  description: Accumulates EV charging session energy when cable disconnects
  trigger:
    - platform: state
      entity_id: sensor.anderson_ev_charger_connection_session_energy
      to: "0"
  condition:
    - condition: template
      value_template: "{{ states('input_number.ev_last_session_energy') | float(0) > 0 }}"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.ev_accumulated_energy
      data:
        value: >
          {{ (states('input_number.ev_accumulated_energy') | float(0) + states('input_number.ev_last_session_energy') | float(0)) | round(2) }}
    - service: input_number.set_value
      target:
        entity_id: input_number.ev_last_session_energy
      data:
        value: 0
  mode: single
