hc_stock_markets_card:
  type: 'custom:button-card'
  entity: sun.sun
  show_label: false
  show_state: false
  show_name: false
  show_icon: false
  tap_action:
    action: none
  triggers_update:
    - sensor.yahoofinance_ftse
    - sensor.yahoofinance_ixic
    - sensor.yahoofinance_nya_2

  styles:
    card:
      - background: 'transparent'
      - border-radius: 12px
      - padding: 8px
      - box-shadow: 'none'
      - min-height: 120px
      - height: auto
      - position: relative
      - overflow: hidden
    custom_fields:
      markets_content:
        - padding: 0
        - margin: 0
        - width: 100%
        - height: 100%
        - position: absolute
        - left: 0
        - top: 0
        - right: 0
        - bottom: 0

  custom_fields:
    markets_content: |
      [[[
        const markets = [
          {
            abbr: 'NYSE',
            name: 'New York',
            entity: 'sensor.yahoofinance_nya_2',
            timezone: 'America/New_York',
            openHour: 9,
            openMinute: 30,
            closeHour: 16,
            closeMinute: 0,
            workDays: [1, 2, 3, 4, 5]
          },
          {
            abbr: 'NASDAQ',
            name: 'New York',
            entity: 'sensor.yahoofinance_ixic',
            timezone: 'America/New_York',
            openHour: 9,
            openMinute: 30,
            closeHour: 16,
            closeMinute: 0,
            workDays: [1, 2, 3, 4, 5]
          },
          {
            abbr: 'LSE',
            name: 'London',
            entity: 'sensor.yahoofinance_ftse',
            timezone: 'Europe/London',
            openHour: 8,
            openMinute: 0,
            closeHour: 16,
            closeMinute: 30,
            workDays: [1, 2, 3, 4, 5]
          }
        ];

        function formatTime(date) {
          return date.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true
          });
        }

        let marketsHtml = '';
        markets.forEach((market, index) => {
          const marketEntity = states[market.entity];
          const attrs = marketEntity ? marketEntity.attributes : {};
          // Get market data from Yahoo Finance entity
          const changePercent = attrs.regularMarketChangePercent;
          const trending = attrs.trending || 'neutral';
          // Format percentage - keep the sign
          const percentValue = changePercent != null ? parseFloat(changePercent) : 0;
          const percentStr = percentValue.toFixed(2) + '%';
          const isPositive = trending.toLowerCase() === 'up';
          // Get market time
          const now = new Date();
          const marketTime = new Date(now.toLocaleString('en-US', { timeZone: market.timezone }));
          const timeString = formatTime(marketTime);
          // Market open/close logic (after marketTime is defined)
          const dayOfWeek = marketTime.getDay();
          const isWorkDay = market.workDays.includes(dayOfWeek);
          const openMinutes = market.openHour * 60 + market.openMinute;
          const closeMinutes = market.closeHour * 60 + market.closeMinute;
          const currentMinutes = marketTime.getHours() * 60 + marketTime.getMinutes();
          const isOpen = isWorkDay && currentMinutes >= openMinutes && currentMinutes < closeMinutes;
          // Set box color: gray if closed, else green/red
          const boxBgColor = isOpen ? (isPositive ? '#2ecc71' : '#FF6B6B') : '#bdbdbd';
          // Each box: rounded square, horizontal layout, no city name
          marketsHtml += `
            <div style="
              background: ${boxBgColor};
              border: 1px solid #e0e0e0;
              border-radius: 18px;
              width: 180px;
              min-width: 140px;
              max-width: 200px;
              height: 100px;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              margin-right: 16px;
              margin-bottom: 0;
              box-sizing: border-box;
            ">
              <div style="color: #2c3e50; font-size: 19px; font-weight: bold; margin-bottom: 4px; text-align: center;">
                ${market.abbr}
              </div>
              <div style="color: #2c3e50; font-size: 15px; margin-bottom: 6px; text-align: center; font-weight: bold;">
                ${timeString}
              </div>
              <div style="display: flex; align-items: center; gap: 6px; font-size: 18px; font-weight: 600; color: #fff; justify-content: center;">
                <span>${percentStr}</span>
              </div>
            </div>
          `;
        });
        // Wrap all boxes in a horizontal flex row
        return `
          <div style="position: relative; width: 100%; height: 100%; box-sizing: border-box; margin: 0; padding: 12px;">
            <div style="display: flex; flex-direction: row; align-items: flex-start; justify-content: flex-start; gap: 0;">
              ${marketsHtml}
            </div>
          </div>
        `;
      ]]]